<html>
  <head>
    <meta charset="utf-8" />
    <title>drift</title>
    <style>
body {
    margin: 0;
    padding: 0;
    background-color: #333;
    color: black;
    font-family: Helvetica, sans;
    font-size: 10pt;
    overflow: hidden;
}
.driftwindow {
    background-color: white;
    border: 2px solid black;
    position: relative;
    overflow-x: auto;
    overflow-y: hidden;
}
.word {
    position: absolute;
    bottom: 0;
}
.word.active {
    color: red;
}
.wav {
    position: absolute;
    top: 0;
}
.pitches {
    position: absolute;
    top: 200;
}
.razor {
    background-color: red;
    width: 1px;
    position: absolute;
    top: 0;
    z-index: 20;
}
.zoom {
    height: 15px;
    position: absolute;
    background-color: white;
    border: 1px solid black;
    text-align: right;
    font-style: italic;
    padding: 0 5px;
}
.zoom .amount { 
    position: absolute;
    top: -7;
    height: 26px;
    width: 6px;
    background-color: #999;
    border: 2px solid black;
}
</style>
  </head>
  <body>
Loading...
    <script>

function _get(url, cb) {
    var xhr = new XMLHttpRequest();
    xhr.open("GET", url, true);
    xhr.onload = function() {
        cb(this.responseText);
    }
    xhr.send();
}
function _get_json(url, cb) {
    _get(url, function(x) {
        cb(JSON.parse(x));
    });
}

var DriftWindow = function(words, pitches, energy, seek_cb) {
    this.words = words;
    this.pitches = pitches;
    this.energy = energy;
    
    // rmo -> mhawkins: We should probably use an event framework. I
    // use this thing called "Triggerable" in seatbelt.js, but you may
    // have some preferenes?
    this.seek_cb = seek_cb;

    this.CHUNK_W = 1000;        // px
    this.WAV_H = 200;
    this.PITCH_H = 200;
    this.WORDS_H = 50;    
    this.SCALE_X  = 150;        // Pixels/second

    this.MAX_PITCH = this.pitches.reduce(function(x,y) { return x > y ? x : y; });

    this.$el = document.createElement("div");
    this.$el.className = "driftwindow";
    this.$cont = document.createElement("div");
    this.$cont.className = "cont";
    this.$el.appendChild(this.$cont);

    this.$el.style.height = this.WAV_H + this.PITCH_H + this.WORDS_H;
    this.$el.style.width = this.CHUNK_W;
    
    this.$cont.style.width = this.t2px(this.pitches.length/100);
    this.$cont.style.height = this.WAV_H + this.PITCH_H + this.WORDS_H;

    this.$razor = document.createElement("div");
    this.$razor.className = "razor";
    this.$razor.style.height = this.WAV_H + this.PITCH_H + this.WORDS_H;
    this.$el.appendChild(this.$razor);

    this.chunks$ = {};          // idx -> {words: $div, pitch: $canvas, wav: $canvas}

    this.show_visible();
    this.$el.onscroll = this.show_visible.bind(this);

    this.$el.onclick = function(ev) {
        // Computation assumes window starts at 0 (should use $el.offsetLeft, etc).
        this.seek_cb(this.px2t(this.$el.scrollLeft + ev.clientX));
    }.bind(this)
}
DriftWindow.prototype.reset = function() {
    this.$cont.innerHTML = "";
    this.chunks$ = {};
}
DriftWindow.prototype.set_scale_x = function(sx) {
    // lock razor position?
    var rx = this.$razor.offsetLeft - this.$el.scrollLeft;
    var cur_t = this.px2t(this.$razor.offsetLeft);
    
    this.reset();
    this.SCALE_X = sx;
    this.$cont.style.width = this.t2px(this.pitches.length/100);
    this.show_visible();

    this.$el.scrollLeft = this.t2px(cur_t) - rx;
}
DriftWindow.prototype.set_t = function(t) {
    this.$razor.style.left = this.t2px(t);
    // TODO: auto-scroll

    // Highlight current word
    var wds = this.words
        .filter(function(x) {
            return x.start <= t && x.end >= t;
        });
    var new_wd;
    if(wds.length > 0) {
        new_wd = wds[0];
        if(new_wd == this.cur_wd) {
            // No change
            return;
        }
        if(new_wd && new_wd.__$div) {
            new_wd.__$div.classList.add("active");
        }
    }
    if(this.cur_wd && this.cur_wd.__$div) {
        this.cur_wd.__$div.classList.remove("active");
    }
    this.cur_wd = new_wd;
}
DriftWindow.prototype.show_visible = function() {
    var x = this.$el.scrollLeft;
    var w = this.$el.clientWidth;

    var chunk_idx = Math.floor(x / this.CHUNK_W);
    var end_chunk_idx = Math.ceil((x+w) / this.CHUNK_W);
    while(chunk_idx <= end_chunk_idx) {
        if(!(chunk_idx in this.chunks$)) {
            this.chunks$[chunk_idx] = {};
            this.render_chunk(chunk_idx);
        }
        chunk_idx += 1;
    }
}
DriftWindow.prototype.px2t = function(x) {
    return x / this.SCALE_X;
}
DriftWindow.prototype.t2px = function(t) {
    return t * this.SCALE_X;
}
DriftWindow.prototype.pitch2px = function(p) {
    return this.t2px(p/100);
}
DriftWindow.prototype.px2pitch = function(x) {
    return Math.round(this.px2t(x) * 100);
}
DriftWindow.prototype.render_chunk = function(idx) {
    this.render_wav(idx);
    this.render_pitch(idx);
    this.render_words(idx);
}
DriftWindow.prototype.render_wav = function(idx) {
    var $can = document.createElement("canvas");
    $can.className = "wav";
    $can.setAttribute("width", this.CHUNK_W);
    $can.setAttribute("height", this.WAV_H);
    $can.style.left = this.CHUNK_W * idx;
    this.chunks$["$wav"] = $can;    
    this.$cont.appendChild($can);

    var start_pitch_idx = this.px2pitch(idx*this.CHUNK_W);
    var end_pitch_idx = this.px2pitch((idx+1)*this.CHUNK_W);

    var ctx = $can.getContext("2d");
    ctx.beginPath();
    for(var i=start_pitch_idx; i<end_pitch_idx; i++) {
        // x-offset (assumes linear time)
        var x = this.pitch2px(i-start_pitch_idx);
        var h = this.energy[i] * (this.WAV_H*0.5);
        // Center vertically
        var y = this.WAV_H/2 - h/2;

        ctx.moveTo(x,y);
        ctx.lineTo(x,y+h);
    }
    ctx.lineWidth = 2;
    ctx.strokeStyle = "black";
    ctx.stroke();
}
DriftWindow.prototype.render_pitch = function(idx) {
    var $can = document.createElement("canvas");
    $can.className = "pitches";
    $can.setAttribute("width", this.CHUNK_W);
    $can.setAttribute("height", this.WAV_H);
    $can.style.left = this.CHUNK_W * idx;
    this.chunks$["$wav"] = $can;    
    this.$cont.appendChild($can);

    var start_pitch_idx = this.px2pitch(idx*this.CHUNK_W);
    var end_pitch_idx = this.px2pitch((idx+1)*this.CHUNK_W);

    var ctx = $can.getContext("2d");
    ctx.fillStyle = "blue";
    for(var i=start_pitch_idx; i<end_pitch_idx; i++) {
        if(this.pitches[i] == 0) {
            continue;
        }
        
        // x-offset (assumes linear time)
        var x = this.pitch2px(i-start_pitch_idx);
        var y = this.PITCH_H - (this.pitches[i] * (this.PITCH_H / this.MAX_PITCH));
        var r = 2;
        x -= r/2;
        y -= r/2;

        ctx.beginPath();
        ctx.arc(x, y, r, 0, 2*Math.PI);
        ctx.fill();
    }
}
DriftWindow.prototype.render_words = function(idx) {
    var $wds = document.createElement("div");
    this.chunks$["$words"] = $wds;
    this.$cont.appendChild($wds);

    var start_t = this.px2t(idx * this.CHUNK_W);
    var end_t   = this.px2t((idx+1) * this.CHUNK_W);

    this.words
        .filter(function(x) {
            // XXX: Words straddling split point may be rendered twice.
            return x.start > 0 && x.start < end_t && x.end > start_t;
        })
        .forEach(function(x) {
            var $w = document.createElement("div");
            x.__$div = $w;
            $w.className = "word";
            $w.style.left = this.t2px(x.start);
            $w.textContent = x.word;
            $wds.appendChild($w);
        }, this)
}

var ZoomBar = function(zoom_cb) {
    this.ZOOM_W = 300;

    this.zoom_cb = zoom_cb;

    this.$el = document.createElement("div");
    this.$el.className = "zoom";    
    this.$el.innerHTML = "zoom";
    this.$el.style.width = this.ZOOM_W - 10; // (padding)

    this.$amnt = document.createElement("div");
    this.$amnt.className = "amount";
    this.$el.appendChild(this.$amnt);

    this.$el.onmousedown = function(ev) {
        // XXX: abstract to handle touch events as well
        ev.preventDefault();

        window.onmousemove = function(ev) {
            ev.preventDefault();

            var amnt = (ev.clientX - this.$el.offsetLeft) / this.ZOOM_W;
            // Clip
            amnt = Math.min(1, Math.max(0, amnt));
            this.set_zoom(amnt);
            this.zoom_cb(amnt);

        }.bind(this)
        window.onmouseup = function(ev) {
            ev.preventDefault();
            window.onmousemove = null;            
            window.onmouseup = null;
        }
    }.bind(this)

    this.set_zoom(0.5);
}
ZoomBar.prototype.set_zoom = function(amnt) {
    this.$amnt.style.left = amnt * this.ZOOM_W - 5;
}

var drift_window, zoombar;
var $a = document.createElement("audio");
$a.src = "a.wav";

_get_json("words.json", function(words) {
    _get("pitches.txt", function(pitch_txt) {

        var ret = parse_pitches(pitch_txt);

        document.body.innerHTML = "";
        drift_window = new DriftWindow(words, ret["pitches"], ret["energy"], on_seek);
        document.body.appendChild(drift_window.$el);

        zoombar = new ZoomBar(function(amnt) {
            drift_window.set_scale_x(50 + amnt*250);
        });
        zoombar.$el.style.left = 700;
        zoombar.$el.style.top = 500;
        document.body.appendChild(zoombar.$el);

        tick();
    });
});

function on_seek(t) {
    $a.currentTime = t;
}

window.onkeydown = function(ev) {
    if(ev.keyCode == 32) {      // space bar
        ev.preventDefault();
        if($a.paused) {
            $a.play();
        }
        else {
            $a.pause();
        }
    }
}

function tick() {
    drift_window.set_t($a.currentTime);
    window.requestAnimationFrame(tick);
}

function parse_pitches(txt) {
    var lines = txt.split('\n');
    var pitches = [];
    var energy  = [];

    lines.forEach(function(l) {
        var parts = l.split(' ');
        if(parts.length > 2) {
            pitches.push(Number(parts[1]));
            energy.push(Number(parts[2]));
        }
    });

    return {pitches: pitches, energy: energy};
}
      
    </script>
  </body>
</html>
